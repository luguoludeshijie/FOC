 /*******************************************************************************
 *
 * 文件名称: Motor_Hall.c
 * 版 本 号: V1.0 
 * 作    者: linbo.liu
 * 生成日期: 2024年x月x日
 * 功能描述:hall信号处理 
 *
 *******************************************************************************/
 /*******************************************************************************
  *----------------------------------头文件--------------------------------------
  ******************************************************************************/
#include "Srv.h"
 
 /*******************************************************************************
  *----------------------------------宏定义---------------------------------------
  ******************************************************************************/
 
 
 /*******************************************************************************
  *--------------------------------数据类型定义-----------------------------------
  ******************************************************************************/
 
 
 /*******************************************************************************
  *----------------------------------函数声明-------------------------------------
  ******************************************************************************/
 static void FOC_HALL_CC_IRQ_Handler(FOC_HALL_T *foc_hall);
 
/*******************************************************************************
 *-----------------------------------常量定义------------------------------------
 ******************************************************************************/

 
/*******************************************************************************
 *-----------------------——--------全局变量定义----------------------------------
 ******************************************************************************/
 FOC_HALL_T g_Hall;

 
/*******************************************************************************
 *---------------------------—----—--函数实现------------------------------------
 ******************************************************************************/
void Motor_HALLInit(void)
{
    Move_Filter_Init(&g_Hall.Secsize_filter, 12);
    Move_Filter_Clear(&g_Hall.Secsize_filter);
}
/*******************************************************************************
 * 函 数 名: BLDCMotor_PhaseCtrl
 * 功能描述: BLDC方波控制
 * 输入参数: HALLPhase:当前hall状态
 * 输出参数: void
*******************************************************************************/
 void BLDCMotor_PhaseCtrl(int32_t HALLPhase )
{   
	switch (HALLPhase)
	{
	case 5: 
	{
		uint16_t Duty[3] = {200,0,0};
		Set_PWMValue(Duty);
	}
	break;

	case 4: 
	{
		uint16_t Duty[3] = {200,200,0};
		Set_PWMValue(Duty);
	}
	break;

	case 6:
	{
		uint16_t Duty[3] = {0,200,0};
		Set_PWMValue(Duty);
	}
	break;

	case 2: 
	{
		uint16_t Duty[3] = {0,200,200};
		Set_PWMValue(Duty);
	}
	break;

	case 3: 
	{
		uint16_t Duty[3] = {0,0,200};
		Set_PWMValue(Duty);
	}
	break;
	case 1: 
	{
		uint16_t Duty[3] = {200,0,200};
		Set_PWMValue(Duty);
	}
	break;
	}
}

/*******************************************************************************
* 函 数 名: HAL_TIM_IC_CaptureCallback
* 功能描述: 定时器中断回调
* 输入参数: htim:定时器
* 输出参数: void
*******************************************************************************/
void HAL_TIM_IC_CaptureCallback(TIM_HandleTypeDef *htim)
{
    if(htim->Instance==TIM5){
        FOC_HALL_CC_IRQ_Handler(&g_Hall);
    }
}

extern IPARK g_IPARKPara;
/*******************************************************************************
* 函 数 名: FOC_HALL_CC_IRQ_Handler
* 功能描述: 霍尔中断处理
* 输入参数: foc_hall:Hall结构体
* 输出参数: void
*******************************************************************************/
static void FOC_HALL_CC_IRQ_Handler(FOC_HALL_T *foc_hall)
{

}
 
/*******************************************************************************
* 函 数 名: Hall_SelfLearning
* 功能描述: 霍尔自学习，自动标定每个霍尔区间的起始角度和宽度
* 输入参数: void
* 输出参数: void
*******************************************************************************/
void Hall_SelfLearning(void)
{
    // 1. 使能电机低速匀速正反转，记录每个霍尔状态变化时的电角度
    // 2. 依次采集6个区间的起始角度和宽度，存入g_Hall.Sector_pos/size等
    // 3. 建议在自学习期间关闭FOC闭环，采用开环电流或电压控制
    // 4. 标定完成后可将参数保存到Flash

    // 伪代码流程如下，具体实现需结合实际硬件和控制流程：
    // for (int dir = 0; dir < 2; dir++) // 0:正转 1:反转
    // {
    //     启动电机低速匀速旋转(dir方向);
    //     等待电机稳定;
    //     for (int i = 0; i < 6; i++)
    //     {
    //         等待霍尔状态变化;
    //         记录当前电角度 HallAngle;
    //         g_Hall.Sector_pos[i] = HallAngle;
    //         等待下一个霍尔状态变化;
    //         记录当前电角度 HallAngle2;
    //         g_Hall.Sector_size[i] = HallAngle2 - HallAngle;
    //     }
    //     // 可选: 反转时记录g_Hall.Sector_pos_c/size_c
    // }
    // 标记自学习完成
}
 
/*******************************************************************************
 *---------------------------—----—---结束--------------------------------------
******************************************************************************/
 