/*******************************************************************************
*
* 文件名称: Motor_Pid.c
* 版 本 号: V1.0 
* 作    者: linbo.liu
* 生成日期: 2024年x月x日
* 功能描述: 
*
*******************************************************************************/
/*******************************************************************************
 *----------------------------------头文件--------------------------------------
 ******************************************************************************/
#include "Srv.h"

/*******************************************************************************
 *----------------------------------宏定义---------------------------------------
 ******************************************************************************/


/*******************************************************************************
 *--------------------------------数据类型定义-----------------------------------
 ******************************************************************************/


/*******************************************************************************
 *----------------------------------函数声明-------------------------------------
 ******************************************************************************/


/*******************************************************************************
 *-----------------------------------常量定义------------------------------------
 ******************************************************************************/


/*******************************************************************************
 *-----------------------——--------全局变量定义----------------------------------
 ******************************************************************************/
PI_Control   g_Speed_PiPara;
PI_Control   g_Id_PiPara;
PI_Control   g_Iq_PiPara;


/*******************************************************************************
 *---------------------------—----—--函数实现------------------------------------
 ******************************************************************************/
void  PI_Controller(p_PI_Control  pV)
{
    /* proportional term */
	pV->up = pV->Ref - pV->Fbk; // 偏差计算

	/* integral term */
	pV->ui = (pV->Out == pV->v1)?(pV->Ki*pV->up+ pV->i1): pV->i1;  // 抗积分饱和，锁定PI饱和时的积分值
	pV->i1 = pV->ui;  // 当out等于v1时输出，没有达到最大值，没有限制输出，当不等于的时候就是溢出最大，消除积分累加项

	/* control output*/
	pV->v1 = pV->Kp*pV->up  + pV->ui;  // 比例量角积分量
	pV->Out= Limit_Sat(pV->v1, pV->Umax, pV->Umin); // 限制PI输出，超出最大值
}

void  PI_Pare_init(void )
{
	  g_Speed_PiPara.Kp = 0.000;
	  g_Speed_PiPara.Ki = 0.000;   // 0.0001*10 / 0.2   T*SpeedLoopPrescaler/0.2
	  g_Speed_PiPara.Umax = 1.5;    //  电流 100
	  g_Speed_PiPara.Umin = -1.5;   //  -100

	  g_Id_PiPara.Kp = 0.00;  
	  g_Id_PiPara.Ki = 0.000;  
	  g_Id_PiPara.Umax =  PI_MAX_Ud;
	  g_Id_PiPara.Umin = -PI_MAX_Ud;

	  g_Iq_PiPara.Kp = 0.000;
	  g_Iq_PiPara.Ki = 0.000;
	  g_Iq_PiPara.Umax =  PI_MAX_Uq;
	  g_Iq_PiPara.Umin = -PI_MAX_Uq;  //-PI_MAX_Uq
}

/*******************************************************************************
 *---------------------------—----—---结束--------------------------------------
 ******************************************************************************/